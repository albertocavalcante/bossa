# --- Lefthook Configuration ---
# See: https://github.com/evilmartians/lefthook

pre-commit:
  parallel: true
  commands:
    # Check Rust formatting
    cargo-fmt:
      glob: "**/*.rs"
      run: cargo fmt -- --check

    # Run Clippy linter
    cargo-clippy:
      glob: "**/*.rs"
      run: cargo clippy --workspace --all-targets -- -D warnings

    # Shell script linting
    shellcheck:
      glob: "**/*.sh"
      run: shellcheck {staged_files}

    # Check Markdown formatting
    dprint-md:
      glob: "**/*.md"
      run: dprint check {staged_files}

    # Check TOML formatting
    dprint-toml:
      glob: "**/*.toml"
      run: dprint check {staged_files}

    # Check JSON formatting
    dprint-json:
      glob: "**/*.json"
      run: dprint check {staged_files}

    # Check YAML formatting
    dprint-yaml:
      glob: "**/*.{yaml,yml}"
      run: dprint check {staged_files}

    # GitHub Actions workflow linting
    workflow-lint:
      glob: ".github/workflows/*.{yml,yaml}"
      run: ghalint run -c tools/lint/ghalint.yaml
      fail_text: "Fix GitHub Actions workflow issues (ghalint)"

    # Verify action versions are pinned to SHAs
    workflow-pin:
      glob: ".github/workflows/*.{yml,yaml}"
      run: pinact run --verify -c tools/lint/pinact.yaml
      fail_text: "Run 'pinact run -u -c tools/lint/pinact.yaml' to pin action versions"

pre-push:
  commands:
    # Run the same Clippy command used in CI
    cargo-clippy:
      run: cargo clippy --workspace --all-targets -- -D warnings

    # Optional extra check: catch Linux-specific lints locally when target is installed
    cargo-clippy-linux:
      run: |
        if rustup target list --installed | grep -q '^x86_64-unknown-linux-gnu$'; then
          cargo clippy --workspace --all-targets --target x86_64-unknown-linux-gnu -- -D warnings
        else
          echo "Skipping Linux clippy (target x86_64-unknown-linux-gnu not installed)"
        fi

    # Run tests before pushing
    cargo-test:
      run: cargo test --quiet

    # Ensure it builds in release mode
    cargo-build:
      run: cargo build --release --quiet

    # Bazel build verification
    bazel-build:
      run: bazel build //:bossa --config=ci

commit-msg:
  commands:
    conventional-commit:
      run: |
        commit_msg=$(head -n1 {1})
        if ! echo "$commit_msg" | grep -qE "^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\([^)]+\))?!?: .+$"; then
          echo "Error: Commit message does not follow conventional commits format."
          echo "Example: feat(brewkit): add formula generation"
          exit 1
        fi
